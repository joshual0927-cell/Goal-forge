<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Goal-Forge – AI Weekly Planner</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #6B4EFF, #10B981);
      color: white;
      text-align: center;
      padding: 60px 20px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    h1 { font-size: 3.5rem; margin: 0; }
    p { font-size: 1.3rem; max-width: 600px; margin: 20px auto; }
    .btn {
      background: white; color: #6B4EFF; padding: 16px 32px;
      font-weight: 700; font-size: 1.2rem; border-radius: 12px;
      text-decoration: none; display: inline-block; margin-top: 20px;
      cursor: pointer; border: none;
    }
    .btn:hover { transform: scale(1.05); }
  </style>
</head>
<body>
  <h1>Goal-Forge</h1>
  <p>Turn “run a marathon” into a weekly plan — and sync it to your calendar in 60 seconds.</p>

  <form id="goalForm" style="margin-top: 40px; max-width: 500px; margin-left: auto; margin-right: auto;">
    <textarea
      id="goalsInput"
      placeholder='Try:&#10;"Run a 5K in 8 weeks"&#10;"Work 9–5 Mon–Fri"&#10;"Gym 3x/week"&#10;"Sleep 10 PM – 6 AM"'
      style="width: 100%; height: 140px; padding: 14px; border-radius: 12px; font-size: 1rem; font-family: Inter, sans-serif; margin-bottom: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
      required></textarea>
    <button type="submit" class="btn" style="width: 100%;">Generate My Week</button>
  </form>

  <div id="result" style="margin-top: 30px; color: white; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; display: none; max-height: 600px; overflow-y: auto;"></div>

  <div id="syncSection" style="margin-top: 20px; display: none; text-align:center;">
    <button id="syncBtn" class="btn" style="background: #4285F4; color: white; width:100%; max-width:400px;">
      Sync to Google Calendar
    </button>
    <p id="syncStatus" style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8; color:white;"></p>
  </div>

  <!-- FINAL WORKING SCRIPT -->
  <script>
    let currentPlan = null;

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('goalForm');
      const result = document.getElementById('result');
      const syncSection = document.getElementById('syncSection');

      if (!form || !result || !syncSection) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('goalsInput').value.trim();
        if (!input) return;

        result.style.display = 'block';
        result.innerHTML = '<p style="margin:0; opacity:0.8; color:white;">Thinking...</p>';

        try {
          const res = await fetch('/api/plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ input })
          });

          if (!res.ok) throw new Error(`API ${res.status}`);

          const data = await res.json();
          currentPlan = data;  // Save for sync

          // === PERFECT GRID ===
          const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
          const hours = Array.from({length: 24}, (_, i) => i);

          let gridHTML = `
            <div style="margin-top:20px; font-family:Inter,sans-serif;">
              <h3 style="margin:0 0 10px; color:white; font-weight:700;">${data.week}</h3>
              <div style="overflow-x:auto;">
                <div style="display:grid; grid-template-columns: 70px repeat(7, 1fr); grid-template-rows: repeat(24, 30px); gap:2px; font-size:0.8rem; min-width:800px;">
                  <div></div>`;

          days.forEach(day => {
            gridHTML += `<div style="grid-row:1; text-align:center; font-weight:700; color:#e2e8f0; padding:8px 0; background:rgba(255,255,255,0.1); border-radius:6px;">${day.slice(0,3)}</div>`;
          });

          hours.forEach(hour => {
            const hourStr = `${hour.toString().padStart(2, '0')}:00`;
            const row = hour + 2;

            gridHTML += `<div style="grid-row:${row}; grid-column:1; text-align:left; color:#94a3b8; font-weight:600; padding:4px 0;">${hourStr}</div>`;

            days.forEach((day, dayIndex) => {
              const col = dayIndex + 2;
              const event = data.events.find(e => 
                e.day === day && 
                parseInt(e.start.split(':')[0]) === hour &&
                !e.rendered
              );

              if (event) {
                const startHour = parseInt(event.start.split(':')[0]);
                const endHour = parseInt(event.end.split(':')[0]);
                const rowspan = endHour > startHour ? endHour - startHour : 24 - startHour + endHour;

                const colorMap = { gray: '#64748b', blue: '#3b82f6', teal: '#14b8a6' };
                const bg = colorMap[event.color] || '#6b7280';

                gridHTML += `<div style="
                  grid-row: ${row} / span ${rowspan};
                  grid-column: ${col};
                  background:${bg}; 
                  color:white; 
                  padding:6px 8px; 
                  border-radius:6px; 
                  font-weight:600; 
                  display:flex; 
                  flex-direction:column; 
                  justify-content:center;
                  min-height:${rowspan * 30}px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                ">
                  <div style="font-size:0.8rem;">${event.title}</div>
                  <div style="font-size:0.7rem; opacity:0.9; margin-top:2px;">${event.start}–${event.end}</div>
                </div>`;

                event.rendered = true;
              }
            });
          });

          gridHTML += `</div></div></div>`;
          result.innerHTML = gridHTML;
          syncSection.style.display = 'block';

        } catch (err) {
          result.innerHTML = `<p style="color:#ff6b6b;">Error: ${err.message}</p>`;
        }
      });
    });
  </script>

  <!-- GOOGLE CALENDAR SYNC -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    document.getElementById('syncBtn')?.addEventListener('click', () => {
      if (!currentPlan) return;
      google.accounts.oauth2.initTokenClient({
        client_id: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/calendar.events',
        callback: (resp) => {
          if (resp.error) return;
          syncToCalendar(resp.access_token);
        }
      }).requestAccessToken();
    });

    async function syncToCalendar(token) {
      const status = document.getElementById('syncStatus');
      status.textContent = 'Syncing...';
      let count = 0;
      for (const e of currentPlan.events) {
        const dayIndex = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].indexOf(e.day);
        const date = new Date(2025, 5, 3 + dayIndex); // June 3 = Monday
        const [year, month, day] = [date.getFullYear(), String(date.getMonth() + 1).padStart(2, '0'), String(date.getDate()).padStart(2, '0')];
        await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            summary: e.title,
            start: { dateTime: `${year}-${month}-${day}T${e.start}:00` },
            end: { dateTime: `${year}-${month}-${day}T${e.end}:00` },
            colorId: e.color === 'blue' ? '11' : e.color === 'teal' ? '10' : '9'
          })
        });
        count++;
      }
      status.innerHTML = `Synced ${count} events to Google Calendar!`;
    }
  </script>
</body>
</html>
